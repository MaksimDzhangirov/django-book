# Часть 1: Рефакторинг проекта и знакомство с API для настроек Django

В этом разделе рассматриваются вопросы, касающиеся изменения структуры проекта, дается введение в API для настроек Django, а также проверяется работоспособность проекта!

---

## Введение

Для тех, кто только что присоединился к нам, предыдущая часть современного учебника по Django находится здесь: [Часть 0: Введение и начальная настройка](/chast-0-vvedenie-i-nachalnaya-nastroika.md).

GitHub этого проекта и всех его частей можно найти по [этой ссылке](https://github.com/djstein/modern-django).

На данный момент мы успешно создали Django проект. Тем не менее, предстоит ещё много сделать прежде, чем мы сможем сказать, что его можно использовать для локальной разработки и создания нашего первого приложения. Сначала мы должны изменить наш файл зависимостей проекта \(файл `requirements.txt` - прим. переводчика\). Затем мы должны изменить настройки проекта. Мы создадим набор переменных окружения для хранения секретных значений. Все это приведет к увеличению скорости разработки, тестирования и развертывания нашего приложения в будущем.

После изменения настроек, мы пройдемся по стандартной части API для настроек Django, которые используются нашим проектом и были созданы при первом создании `settings.py`. Также мы познакомимся с некоторыми часто используемыми настройками не создаваемыми по умолчанию, например, касающиеся обработки статических файлов. Понимание API для настроек Django - это первый шаг, позволяющий пролить свет на то, что называется _Магией Django_. Мы проведем ещё одну небольшую реструктуризацию и затем убедимся в работоспособности проекта!

Важно, чтобы все новые пользователи чувствовали себя уверенно при работе с настройками Django, поэтому я извиняюсь перед теми из Вас, кто хорошо знает Django или хочет начать работать с [REST API](https://en.wikipedia.org/wiki/Representational_state_transfer). Я могу только попробовать развеселить Вас во время изучения частей касающихся настроек, как эта \(на этот раз все смешные картинки находятся внизу\).

**Замечание:** Будем откровенны. В этой части Вы увидите структуру приложения, аналогичную структуре, которую создала [Django команда Cookiecutter](https://github.com/pydanny/cookiecutter-django) \(**C**ookie**c**utter **D**jango - CCD\). Если мы не будем использовать CCD проект, то в конечном итоге просто расширим базовый Django проект, пока нам не понадобятся какие-то более сложные части, поэтому мне кажется, что такой способ лучше. Команда CCD столкнулась с множеством локальных и продакшен проблем и решила их. Я принял во внимание их структуру, сравнивая её с той, что нужна нам. Хотя на ранних стадиях наш проект может казаться похожим на их, важно пояснить что делается на каждом этапе вместо того, чтобы слепо создавать шаблонный проект. Наш проект будет сильно отличаться в будущем , но сейчас Вы можете заметить структурное сходство. Например, существенная разница будет заключаться в том, что мы удалим формирование страниц на стороне сервера \(как это делается в CDD и многих других проектах\), а будем использовать REST API в сочетании с фронтэнд JavaScript фреймворком.

**Временное замечание:** Это замечание касается тех, кто использовал старую версию Части 0 \(до 24/02/2017\), поскольку мы обновили структуру проекта. В частности была обновлена команда `django-admin startproject` из части 0. Простите, ребята. Чтобы привести старую структуру приложения к новой потребуется большое количество изменений. Поэтому проще для всех будет, если те, кто использовал старую версию Части 0, просто удалят каталог `project` и создадут проект, используя новое имя и путь.

Для этого перейдите в каталог `modern-django`, удалите старый проект и создайте новый. Используйте команды:

```
# Команды
cd ~/git/modern-django/
rm -rf project/
django-admin startproject config .
```

> Примечание переводчика. Эта часть переводилась после 24/02/2017, следовательно, ничего исправлять не надо.

## Используемые технологии

В этой части мы изучим намного меньше технологий.

* Django настройки: "Файл с настройками Django содержит полную конфигурацию установленного Django проекта” \([источник](https://docs.djangoproject.com/en/1.10/topics/settings/)\). Это набор файлов/конфигураций, которые мы изучим в этой части! Это основа любого Django проекта.
* Переменные окружения \(переменные среды\): "Набор динамически задаваемых значений, которые могут повлиять на поведение запущенных процессов в компьютере. Они являются частью среды, в которой выполняется процесс" \([источник](https://en.wikipedia.org/wiki/Environment_variable)\). Мы создадим множество переменных окружения в процессе изучения.
* django-environ: "Позволяет Вам, используя 12 переменных окружения, настраивать Ваше Django приложение" \([источник](https://github.com/joke2k/django-environ)\). Мы установим этот пакет, чтобы упростить работу с переменными окружения для Django!

## Подробное пошаговое руководство

Продолжая с того места, на котором мы остановились в части 0, наша текущая структура проекта выглядит следующим образом!

```
modern-django
├── LICENSE
├── README.md
├── config
│   ├── __init__.py
│   ├── settings.py
│   ├── urls.py
│   └── wsgi.py
├── manage.py
└── requirements.txt
```

С этого момента, я буду предполагать, что Вы находитесь в каталоге `modern-django`, если не указано иное. Чтобы перейти в каталог `modern-django`, используйте следующую команду:

```
# Команда
cd ~/git/modern-django/
```

### 1. Изменяем requirements.txt

В этом разделе мы осуществим рефакторинг `requirements.txt`, сделав его намного более удобным в эксплуатации. Сначала создайте каталог с названием `requirements` в каталоге `modern-django`. Затем скопируйте текущий файл `requirements.txt` в него, переименовав в base.txt. После этого перейдите в каталог `requirements` и создайте файлы с зависимостями для локального, продакшен и тестового окружения.

```
# Команда
mkdir requirements/
mv requirements.txt requirements/base.txt
cd requirements/
touch local.txt production.txt test.txt
```

Теперь мы можем изменять список Python приложений, которые будет использовать наше виртуальное окружение \(или [Docker](https://en.wikipedia.org/wiki/Docker_%28software%29) образ\), основываясь на окружении \(локальная разработка, продакшен или  тестирование\).

#### 1-A. Добавляем django-environ в base.txt {#3c5a}

В файл base.txt, на основе которого будут создаваться все окружения, добавим [django-environ](https://github.com/joke2k/django-environ). Это позволит упростить настройку Django сразу по двум направлениям:

1. Упрощает использование переменных окружения
2. Упрощает пути к файлам

Откройте файл `requirments/base.txt` в Вашем любимом текстовом редакторе и добавьте следующую строку под `django==1.10.5`:

```
django-environ==0.4.1
```

#### **1-B. Осуществляем наследование локальных, продакшен и тестовых зависимостей от base.txt**

Теперь в наши файлы local.txt, production.txt и test.txt мы добавим строку, которая будет рекурсивно получать все зависимости из base.txt. Добавим эту строку в начало только что созданных файлов:

```
-r base.txt
```

Аналогично тому как мы добавили `django` в старый файл `requirements.txt` в части 0, мы будем продолжать добавлять сторонние приложения в проект, используя один из этих файлов. Новые строки будут добавлены в этот файл позднее, во время изучения пособия, а сейчас пора обратить внимание на `settings.py`.

### 2. Изменяем settings.py

В этом разделе, мы осуществим рефакторинг `settings.py`, сделав его более удобным в эксплуатации и разделим его аналогично тому как мы сделали это с `requirements.txt`.  Сначала создадим новый каталог `settings` внутри `config`:

```
# Команда
mkdir config/settings/
```

Теперь переместите файл `settings.py` в каталог `settings` и переименуйте в `base.py`:

```
# Команда
mv config/settings.py config/settings/base.py
```

Далее создайте файлы с настройками для каждого окружения \(локального, продакшен и тестового\):

```
# Команда
cd config/settings/
touch local.py production.py test.py
```

Опять в Вашем любимом текстовом редакторе в начале `local.py`, `production.py` и `test.py` импортируйте `base.py`, добавив:

```
from .base import *
```

Теперь, заложив основу, поря просмотреть и реорганизовать файл настроек `base.py`.

**Замечание:** В вышеприведенной строке импорт осуществлялся следующим образом: `import *`.  Хороший специалист импортирует только те части классов/модулей/библиотек, которые ему необходимы, но этот случай, является исключением.

### 3. Знакомство с API для настроек Django

Пока в base.py находятся только стандартные настройки, созданные командой `django-admin startproject`. Ниже мы рассмотрим каждую настройку одну за другой - определим её своими словами и отредактируем в случае необходимости.

#### 3-A. Добавляем django-environ

Как описано в вышеприведенных разделах, пакет django-environ позволяет упростить использование переменных окружения и пути к файлам.

В `base.py` найдите строку `import os` под сгенерированными комментариями. Этот импорт используется в нескольких местах для получения путей к файлам. Использование `environ` позволяет упростить реализацию этой задачи. Таким образом, найдите строку `import os` и замените её импортом `environ` в начале `base.py`:

```
import environ
```

#### 3-B. Переменные, отвечающие за пути к файлам: меняем BASE\_DIR на ROOT\_DIR + APPS\_DIR {#e994}

Теперь, когда мы удалили `import os`, изменим переменную `BASE_DIR`. `BASE_DIR` обычно используется для создания переменных, хранящих пути к файлам относительно верхнего уровня проекта \(корневого каталога\), т. е. для указания пути к файлу или каталогу с файлами.

Теперь, когда мы импортировали `environ`, мы можем заменить `BASE_DIR`  другой переменной, которую назовём `ROOT_DIR` \(Вы можете просто переименовать переменную или оставить её старое название, но `ROOT_DIR` звучит логичнее, учитывая то, за что отвечает данная переменная\). Добавьте следующую строку:

```
ROOT_DIR = environ.Path(__file__) - 3
```

Эта функция возвращает текущий путь к файлу `~/git/modern-django/config/base.py` и поднимается на три уровня вверх `~/git/modern-django/`. Теперь у нас есть переменная, которая указывает на корневой каталог проекта и мы можем получить путь к любому файлу в каталоге, используя её.

Продемонстрируем, что мы можем получить доступ к любому другому файлу, создав другую переменную, которую назовём `APPS_DIR`. В ней будет храниться путь к ещё не созданному каталогу, в котором позднее будут храниться создаваемые нами приложения. Добавьте переменную `APPS_DIR` ниже `ROOT_DIR`:

```
APPS_DIR = ROOT_DIR.path('project')
```

#### 3-C. Импортируем переменные окружения {#674f}

Ниже только что созданных `ROOT_DIR` и `APPS_DIR`, мы импортируем множество переменных окружения из файла `.env` \(мы его скоро создадим\), которые будут использоваться в проекте. Воспользуемся функцией `environ.Env()` для поиска `.env` файла к нашем корневом каталоге проекта, а затем `read_env()`, чтобы считать переменные из файла. Для этого добавьте следующие строки:

```
env = environ.Env()

# Эта часть добавлена из CookieCutter Django и гарантирует отсутствие ошибок при запуске локального сервера/миграциях
READ_DOT_ENV_FILE = env.bool('DJANGO_READ_DOT_ENV_FILE', default=False)

if READ_DOT_ENV_FILE:
    env_file = str(ROOT_DIR.path('.env'))
    print('Loading : {}'.format(env_file))
    env.read_env(env_file)
    print('The .env file has been loaded. See base.py for more information')
```

**Замечание:** Основная причина добавления этого функционала именно сейчас заключается в том, что при использовании [Docker](https://en.wikipedia.org/wiki/Docker_%28software%29) контейнеров, мы будем считывать переменные окружения из `.env` файла, поскольку могут возникнуть некоторые сложности, если делать это через Docker.

#### 3-D. Вводная информация о SECRET\_KEY и перемещение его в `local.py` {#010f}

**!!! ЕСЛИ ВЫ НЕ ЧИТАЛИ ДРУГИЕ РАЗДЕЛЫ, ОБЯЗАТЕЛЬНО ПРОЧИТАЙТЕ ЭТОТ !!!**

После добавления переменных окружения, мы должны настроить `SECRET_KEY`. Секретный ключ в Django чрезвычайно важная переменная и как следует из названия его необходимо держать в тайне. Тем не менее, мы уже передали наш секретный ключ в публичный \(если конечно Вы не создавали приватный репозиторий - прим. переводчика\) репозиторий на GitHub. Не волнуйтесь, это было сделано специально для локальной разработки и позволяет использовать ключ для различных окружений и другими разработчиками. **Учтите, что мы создадим другой секретный ключ при развертывании нашего приложения и он не должен отслеживать системой управления версиями и совместно использоваться с кем-либо.**

Секретный ключ используется в различных частях проекта, например, при создании пользовательских сессий, сообщений, cookies, сбросов паролей и криптографической подписи. Поэтому он очень важен. [Узнать больше о нём можно из официальной документации](https://docs.djangoproject.com/en/1.10/ref/settings/#secret-key).

Для локальной разработки, мы вырежем и вставим \(удалив значение из `base.py`\), переменную `SECRET_KEY` в local.py и отредактируем строку, чтобы она стала выглядеть следующим образом \(значение Вашего ключа будет отличаться от приведенного ниже\):

```
SECRET_KEY = env('DJANGO_SECRET_KEY', default='^92l&5_l2f-ik5xlav!7*cat904fro-lmdd@0kgz@c*nxua3@p')
```

#### 3-E. Вводная информация о DEBUG {#e204}

Следующей по порядку является настройка `DEBUG`. Сейчас она равна `True`.  Когда `DEBUG` равно `True`, происходит множество вещей, например: выводятся страницы с подробными сообщениями об ошибках, сохраняются все осуществленные SQL запросы и переменная ALLOWED\_HOSTS может быть не заполнена. [Узнать больше о `DEBUG` можно здесь](https://docs.djangoproject.com/en/1.10/ref/settings/#debug). Мы должны всегда предполагать, что переменная `DEBUG` будет равна `False`, за исключением случая локальной разработки, когда она равна `True`. Отредактируем текущее значение в `base.py`, приравняв значение переменной окружения к `False`.

```
DEBUG = env.bool('DJANGO_DEBUG', False)
```

Использовать значение `True` для `DEBUG` следует только при локальной разработке, поэтому мы должны также скопировать переменную в `local.py`. Скопируйте и вставьте переменную `DEBUG` в `local.py` и измените значение переменной окружения, приравняв её к `True`.

```
DEBUG = env.bool('DJANGO_DEBUG', default=True)
```

Создание переменной окружения DEBUG позволяет нам более эффективно настраивать инструменты для развертывания, основываясь на значениях переменных окружения!

#### 3-F. Вводная информация о ALLOWED\_HOSTS {#814b}

`ALLOWED_HOSTS` - это список сайтов, с которыми Django может устанавливать соединение и принимать запросы. Для локальной разработки, когда `DEBUG` равно `True`, значение может быть равно пустому списку, но при переходе на продакшен сервер, оно должно быть изменено на определенный домен, например, `.example.com`.

Мы вернемся к этой настройке при развертывании. Пока просто вырежьте и вставьте `ALLOWED_HOSTS` в `production.py` после всех импортов.

#### 3-G. Вводная информация о INSTALLED\_APPS {#c0ad}



